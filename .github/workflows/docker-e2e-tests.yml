name: Docker E2E Tests

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'Dockerfile'
  workflow_dispatch:

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Build Docker image
      run: docker build -t mpo-frontend:test .

    - name: Start container
      run: |
        docker run -d \
          -p 8080:80 \
          -e OAUTH_AUTHORITY=http://localhost:3000 \
          -e OAUTH_CLIENT_ID=test-client-id \
          -e OAUTH_REDIRECT_URI=http://localhost:8080/login_callback.html \
          -e OAUTH_POST_LOGOUT_REDIRECT_URI=http://localhost:8080/login.html \
          --name mpo-test \
          mpo-frontend:test

    - name: Wait for nginx to be ready
      run: |
        echo "Waiting for nginx..."
        for i in $(seq 1 15); do
          if curl -sf http://localhost:8080 > /dev/null; then
            echo "Server is ready"
            exit 0
          fi
          echo "Attempt $i/15 failed, retrying in 2s..."
          sleep 2
        done
        echo "Server did not become ready in time"
        docker logs mpo-test
        exit 1

    - name: Run Playwright tests against Docker image
      uses: ./.github/actions/playwright-test
      with:
        use-existing-server: 'true'
        artifact-name: 'playwright-report-docker'
